{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集成演示系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .event-list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">集成演示系统控制面板</h4>
                    </div>
                    <div class="card-body">
                        <button id="launchBtn" class="btn btn-primary btn-lg">
                            启动演示程序
                        </button>
                        
                        <div id="statusCard" class="card status-card">
                            <div class="card-body">
                                <h5 class="card-title">系统状态</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p>
                                            <span class="status-indicator" id="faceStatus"></span>
                                            人脸检测状态
                                        </p>
                                        <p>
                                            <span class="status-indicator" id="handStatus"></span>
                                            手势检测状态
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p>疲劳度: <span id="fatigueLevel">0%</span></p>
                                        <p>系统状态: <span id="systemStatus">未启动</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-4">
                            <div class="card-header">
                                最近事件
                            </div>
                            <div class="card-body event-list">
                                <ul id="eventList" class="list-group">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let updateInterval;

            $('#launchBtn').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);
                btn.html('<span class="spinner-border spinner-border-sm"></span> 启动中...');

                $.ajax({
                    url: '{% url "launch_demo" %}',
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            btn.removeClass('btn-primary').addClass('btn-success');
                            btn.html('程序已启动');
                            startStatusUpdates();
                        } else {
                            btn.removeClass('btn-primary').addClass('btn-danger');
                            btn.html('启动失败');
                            alert('启动失败: ' + response.message);
                        }
                    },
                    error: function() {
                        btn.prop('disabled', false);
                        btn.removeClass('btn-primary').addClass('btn-danger');
                        btn.html('启动失败');
                        alert('启动请求失败');
                    }
                });
            });

            function startStatusUpdates() {
                updateInterval = setInterval(updateStatus, 1000);
            }

            function updateStatus() {
                $.ajax({
                    url: '{% url "get_detection_data" %}',
                    method: 'GET',
                    success: function(data) {
                        // 更新状态指示器
                        $('#faceStatus').toggleClass('status-active', data.face_detected)
                                      .toggleClass('status-inactive', !data.face_detected);
                        $('#handStatus').toggleClass('status-active', data.hand_detected)
                                      .toggleClass('status-inactive', !data.hand_detected);
                        
                        // 更新疲劳度和系统状态
                        $('#fatigueLevel').text(data.fatigue_level + '%');
                        $('#systemStatus').text(data.system_status);

                        // 更新事件列表
                        updateEventList(data.last_events);
                    }
                });
            }

            function updateEventList(events) {
                const eventList = $('#eventList');
                eventList.empty();
                
                events.slice(0, 10).forEach(function(event) {
                    const time = new Date(event.timestamp).toLocaleTimeString();
                    let eventText = `${time} - ${event.event_type}`;
                    if (event.details && event.details.gesture_name) {
                        eventText += `: ${event.details.gesture_name}`;
                    }
                    
                    const listItem = $('<li>')
                        .addClass('list-group-item')
                        .text(eventText);
                    eventList.append(listItem);
                });
            }
        });
    </script>
</body>
</html> 